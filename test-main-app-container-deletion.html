<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»åº”ç”¨å®¹å™¨åˆ é™¤ä¼˜åŒ–æµ‹è¯•</title>
    <link rel="stylesheet" href="js/lib/jointjs-3.7.7.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .test-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .test-controls {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .test-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .test-button.primary {
            background: #3498db;
            color: white;
        }
        
        .test-button.success {
            background: #27ae60;
            color: white;
        }
        
        .test-button.danger {
            background: #e74c3c;
            color: white;
        }
        
        .test-button.warning {
            background: #f39c12;
            color: white;
        }
        
        .test-button:hover {
            opacity: 0.8;
        }
        
        .test-status {
            margin-left: auto;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status-info { background: #d1ecf1; color: #0c5460; }
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        .test-instructions {
            background: #fff;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .test-instructions h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .test-instructions ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .test-instructions li {
            margin-bottom: 5px;
        }
        
        #paper-container {
            height: calc(100vh - 200px);
            background: white;
            position: relative;
        }
        
        .test-results {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2c3e50;
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            border-top: 3px solid #3498db;
        }
        
        .test-results h4 {
            margin: 0 0 10px 0;
            color: #3498db;
        }
        
        .test-results .log-entry {
            margin-bottom: 5px;
            padding: 2px 5px;
            border-radius: 2px;
        }
        
        .log-info { background: rgba(52, 152, 219, 0.2); }
        .log-success { background: rgba(39, 174, 96, 0.2); }
        .log-warning { background: rgba(243, 156, 18, 0.2); }
        .log-error { background: rgba(231, 76, 60, 0.2); }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>ä¸»åº”ç”¨å®¹å™¨åˆ é™¤ä¼˜åŒ–æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¸»å·¥ä½œæµç¼–è¾‘å™¨ä¸­çš„å®¹å™¨åˆ é™¤ä¼˜åŒ–åŠŸèƒ½</p>
    </div>
    
    <div class="test-controls">
        <button class="test-button primary" onclick="createTestScenario()">åˆ›å»ºæµ‹è¯•åœºæ™¯</button>
        <button class="test-button success" onclick="createConnections()">åˆ›å»ºè¿æ¥çº¿</button>
        <button class="test-button warning" onclick="testContainerDeletion()">æµ‹è¯•å®¹å™¨åˆ é™¤</button>
        <button class="test-button danger" onclick="clearAll()">æ¸…ç©ºç”»å¸ƒ</button>
        <button class="test-button" onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        
        <div class="test-status status-info" id="test-status">
            å‡†å¤‡å°±ç»ª - ç‚¹å‡»"åˆ›å»ºæµ‹è¯•åœºæ™¯"å¼€å§‹
        </div>
    </div>
    
    <div class="test-instructions">
        <h3>æµ‹è¯•è¯´æ˜ï¼š</h3>
        <ol>
            <li><strong>åˆ›å»ºæµ‹è¯•åœºæ™¯</strong>ï¼šåˆ›å»ºä¸€ä¸ªå®¹å™¨å’Œå¤šä¸ªä¸åŒç±»å‹çš„èŠ‚ç‚¹</li>
            <li><strong>åˆ›å»ºè¿æ¥çº¿</strong>ï¼šåœ¨èŠ‚ç‚¹ä¹‹é—´åˆ›å»ºè¿æ¥çº¿</li>
            <li><strong>æ‰‹åŠ¨æµ‹è¯•</strong>ï¼šç‚¹å‡»å®¹å™¨èŠ‚ç‚¹ï¼Œç„¶åç‚¹å‡»åˆ é™¤å›¾æ ‡æµ‹è¯•åˆ é™¤åŠŸèƒ½</li>
            <li><strong>è‡ªåŠ¨æµ‹è¯•</strong>ï¼šç‚¹å‡»"æµ‹è¯•å®¹å™¨åˆ é™¤"è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•</li>
            <li><strong>éªŒè¯ç»“æœ</strong>ï¼šç¡®è®¤å®¹å™¨è¢«åˆ é™¤ï¼ŒåµŒå¥—èŠ‚ç‚¹å’Œè¿æ¥çº¿ä¿ç•™</li>
        </ol>
    </div>
    
    <div id="paper-container"></div>
    
    <div class="test-results">
        <h4>æµ‹è¯•æ—¥å¿—ï¼š</h4>
        <div id="test-log"></div>
    </div>

    <!-- JointJSä¾èµ–åº“ -->
    <script src="js/lib/jquery-3.7.1.min.js"></script>
    <script src="js/lib/underscore-1.13.6.min.js"></script>
    <script src="js/lib/backbone-1.4.1.min.js"></script>
    <script src="js/lib/jointjs-3.7.7.min.js"></script>

    <!-- åº”ç”¨æ¨¡å— -->
    <script src="js/core/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/features/node-manager.js"></script>
    <script src="js/core/graph.js"></script>
    <script src="js/main.js"></script>

    <script>
        // æµ‹è¯•å˜é‡
        let workflowApp;
        let testContainer;
        let testNodes = [];
        let testLinks = [];
        
        // åˆå§‹åŒ–ä¸»åº”ç”¨
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                log('åˆå§‹åŒ–ä¸»å·¥ä½œæµåº”ç”¨...', 'info');
                
                // åˆ›å»ºåº”ç”¨å®ä¾‹
                workflowApp = new WorkflowApp();
                
                // è®¾ç½®å®¹å™¨
                const paperContainer = document.getElementById('paper-container');
                workflowApp.paper.el = paperContainer;
                
                // åˆå§‹åŒ–åº”ç”¨
                await workflowApp.init();
                
                log('ä¸»åº”ç”¨åˆå§‹åŒ–å®Œæˆ', 'success');
                updateStatus('ä¸»åº”ç”¨å·²åˆå§‹åŒ– - å¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
                
            } catch (error) {
                log('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                updateStatus('åˆå§‹åŒ–å¤±è´¥', 'error');
                console.error(error);
            }
        });
        
        // åˆ›å»ºæµ‹è¯•åœºæ™¯
        function createTestScenario() {
            try {
                if (!workflowApp) {
                    updateStatus('åº”ç”¨æœªåˆå§‹åŒ–', 'error');
                    return;
                }
                
                log('åˆ›å»ºæµ‹è¯•åœºæ™¯...', 'info');
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                workflowApp.graph.clear();
                testNodes = [];
                testLinks = [];
                testContainer = null;
                
                // åˆ›å»ºNodeManagerå®ä¾‹
                const nodeManager = new NodeManager(workflowApp);
                
                // åˆ›å»ºå®¹å™¨èŠ‚ç‚¹
                testContainer = nodeManager.createContainerNode(400, 300);
                if (!testContainer) {
                    throw new Error('å®¹å™¨èŠ‚ç‚¹åˆ›å»ºå¤±è´¥');
                }
                testContainer.resize(350, 250);
                workflowApp.graph.addCell(testContainer);
                
                // åˆ›å»ºä¸åŒç±»å‹çš„èŠ‚ç‚¹
                const node1 = nodeManager.createProcessNode(350, 250);  // GroupingèŠ‚ç‚¹
                const node2 = nodeManager.createDecisionNode(500, 250); // å†³ç­–èŠ‚ç‚¹
                const node3 = nodeManager.createProcessNode(350, 350);  // å¦ä¸€ä¸ªGroupingèŠ‚ç‚¹
                const node4 = nodeManager.createSwitchNode(500, 350);   // SwitchèŠ‚ç‚¹
                
                if (!node1 || !node2 || !node3 || !node4) {
                    throw new Error('èŠ‚ç‚¹åˆ›å»ºå¤±è´¥');
                }
                
                // æ·»åŠ èŠ‚ç‚¹åˆ°å›¾ä¸­
                workflowApp.graph.addCell([node1, node2, node3, node4]);
                testNodes = [node1, node2, node3, node4];
                
                // æ‰‹åŠ¨åµŒå¥—èŠ‚ç‚¹åˆ°å®¹å™¨ä¸­
                setTimeout(() => {
                    try {
                        testNodes.forEach(node => {
                            testContainer.embed(node);
                            node.toFront();
                        });
                        
                        log(`æµ‹è¯•åœºæ™¯åˆ›å»ºå®Œæˆ - å®¹å™¨åŒ…å«${testNodes.length}ä¸ªèŠ‚ç‚¹`, 'success');
                        updateStatus('æµ‹è¯•åœºæ™¯å·²åˆ›å»º - å¯ä»¥åˆ›å»ºè¿æ¥çº¿', 'success');
                        
                    } catch (embedError) {
                        log('åµŒå¥—èŠ‚ç‚¹å¤±è´¥: ' + embedError.message, 'error');
                        updateStatus('åµŒå¥—èŠ‚ç‚¹å¤±è´¥', 'error');
                    }
                }, 100);
                
            } catch (error) {
                log('åˆ›å»ºæµ‹è¯•åœºæ™¯å¤±è´¥: ' + error.message, 'error');
                updateStatus('åˆ›å»ºåœºæ™¯å¤±è´¥', 'error');
                console.error(error);
            }
        }
        
        // åˆ›å»ºè¿æ¥çº¿
        function createConnections() {
            try {
                if (!testNodes || testNodes.length < 2) {
                    updateStatus('è¯·å…ˆåˆ›å»ºæµ‹è¯•åœºæ™¯', 'warning');
                    return;
                }
                
                log('åˆ›å»ºè¿æ¥çº¿...', 'info');
                
                // åˆ›å»ºèŠ‚ç‚¹é—´çš„è¿æ¥çº¿
                const link1 = new joint.shapes.standard.Link({
                    source: { id: testNodes[0].id },
                    target: { id: testNodes[1].id },
                    attrs: {
                        line: { stroke: '#333', strokeWidth: 2 }
                    }
                });
                
                const link2 = new joint.shapes.standard.Link({
                    source: { id: testNodes[1].id },
                    target: { id: testNodes[2].id },
                    attrs: {
                        line: { stroke: '#333', strokeWidth: 2 }
                    }
                });
                
                const link3 = new joint.shapes.standard.Link({
                    source: { id: testNodes[2].id },
                    target: { id: testNodes[3].id },
                    attrs: {
                        line: { stroke: '#333', strokeWidth: 2 }
                    }
                });
                
                workflowApp.graph.addCell([link1, link2, link3]);
                testLinks = [link1, link2, link3];
                
                log(`åˆ›å»ºäº†${testLinks.length}æ¡è¿æ¥çº¿`, 'success');
                updateStatus('è¿æ¥çº¿å·²åˆ›å»º - å¯ä»¥æµ‹è¯•åˆ é™¤åŠŸèƒ½', 'success');
                
            } catch (error) {
                log('åˆ›å»ºè¿æ¥çº¿å¤±è´¥: ' + error.message, 'error');
                updateStatus('åˆ›å»ºè¿æ¥çº¿å¤±è´¥', 'error');
                console.error(error);
            }
        }
        
        // æµ‹è¯•å®¹å™¨åˆ é™¤
        function testContainerDeletion() {
            try {
                if (!testContainer) {
                    updateStatus('è¯·å…ˆåˆ›å»ºæµ‹è¯•åœºæ™¯', 'warning');
                    return;
                }
                
                log('å¼€å§‹æµ‹è¯•å®¹å™¨åˆ é™¤...', 'info');
                
                // è®°å½•åˆ é™¤å‰çš„çŠ¶æ€
                const nodesBefore = testNodes.map(node => ({
                    id: node.id,
                    exists: !!workflowApp.graph.getCell(node.id),
                    position: node.position()
                }));
                
                const linksBefore = testLinks.map(link => ({
                    id: link.id,
                    exists: !!workflowApp.graph.getCell(link.id)
                }));
                
                log(`åˆ é™¤å‰çŠ¶æ€: å®¹å™¨å­˜åœ¨, ${nodesBefore.length}ä¸ªèŠ‚ç‚¹, ${linksBefore.length}æ¡è¿æ¥çº¿`, 'info');
                
                // ä½¿ç”¨NodeManageråˆ é™¤å®¹å™¨
                const nodeManager = new NodeManager(workflowApp);
                const deleteResult = nodeManager.deleteNode(testContainer);
                
                log(`åˆ é™¤æ“ä½œç»“æœ: ${deleteResult}`, deleteResult ? 'success' : 'error');
                
                // éªŒè¯åˆ é™¤ç»“æœ
                setTimeout(() => {
                    verifyDeletionResults(nodesBefore, linksBefore);
                }, 200);
                
            } catch (error) {
                log('æµ‹è¯•å®¹å™¨åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                updateStatus('åˆ é™¤æµ‹è¯•å¤±è´¥', 'error');
                console.error(error);
            }
        }
        
        // éªŒè¯åˆ é™¤ç»“æœ
        function verifyDeletionResults(nodesBefore, linksBefore) {
            try {
                const results = [];
                let allPassed = true;
                
                // æ£€æŸ¥å®¹å™¨æ˜¯å¦è¢«åˆ é™¤
                const containerExists = !!workflowApp.graph.getCell(testContainer.id);
                if (containerExists) {
                    results.push('âŒ å®¹å™¨èŠ‚ç‚¹æœªè¢«åˆ é™¤');
                    allPassed = false;
                } else {
                    results.push('âœ… å®¹å™¨èŠ‚ç‚¹å·²æ­£ç¡®åˆ é™¤');
                }
                
                // æ£€æŸ¥åµŒå¥—èŠ‚ç‚¹æ˜¯å¦ä¿ç•™
                let nodesPreserved = 0;
                nodesBefore.forEach((nodeBefore, index) => {
                    const nodeExists = !!workflowApp.graph.getCell(nodeBefore.id);
                    if (nodeExists) {
                        nodesPreserved++;
                        const currentNode = workflowApp.graph.getCell(nodeBefore.id);
                        const currentPos = currentNode.position();
                        
                        // æ£€æŸ¥ä½ç½®æ˜¯å¦ä¿æŒ
                        const positionMaintained = 
                            Math.abs(currentPos.x - nodeBefore.position.x) < 5 &&
                            Math.abs(currentPos.y - nodeBefore.position.y) < 5;
                        
                        if (positionMaintained) {
                            results.push(`âœ… èŠ‚ç‚¹${index + 1}ä½ç½®ä¿æŒæ­£ç¡®`);
                        } else {
                            results.push(`âš ï¸ èŠ‚ç‚¹${index + 1}ä½ç½®å‘ç”Ÿå˜åŒ–`);
                        }
                    } else {
                        results.push(`âŒ èŠ‚ç‚¹${index + 1}ä¸¢å¤±`);
                        allPassed = false;
                    }
                });
                
                if (nodesPreserved === nodesBefore.length) {
                    results.push('âœ… æ‰€æœ‰åµŒå¥—èŠ‚ç‚¹å·²ä¿ç•™');
                } else {
                    results.push(`âŒ åªæœ‰${nodesPreserved}/${nodesBefore.length}ä¸ªèŠ‚ç‚¹è¢«ä¿ç•™`);
                    allPassed = false;
                }
                
                // æ£€æŸ¥è¿æ¥çº¿æ˜¯å¦ä¿ç•™
                let linksPreserved = 0;
                linksBefore.forEach((linkBefore, index) => {
                    const linkExists = !!workflowApp.graph.getCell(linkBefore.id);
                    if (linkExists) {
                        linksPreserved++;
                    } else {
                        results.push(`âŒ è¿æ¥çº¿${index + 1}ä¸¢å¤±`);
                        allPassed = false;
                    }
                });
                
                if (linksPreserved === linksBefore.length) {
                    results.push('âœ… æ‰€æœ‰è¿æ¥çº¿å·²ä¿ç•™');
                } else {
                    results.push(`âŒ åªæœ‰${linksPreserved}/${linksBefore.length}æ¡è¿æ¥çº¿è¢«ä¿ç•™`);
                    allPassed = false;
                }
                
                // è¾“å‡ºç»“æœ
                results.forEach(result => {
                    const type = result.startsWith('âœ…') ? 'success' : 
                                result.startsWith('âš ï¸') ? 'warning' : 'error';
                    log(result, type);
                });
                
                const finalStatus = allPassed ? 
                    'ğŸ‰ æµ‹è¯•é€šè¿‡ï¼å®¹å™¨åˆ é™¤ä¼˜åŒ–åŠŸèƒ½æ­£å¸¸å·¥ä½œ' : 
                    'âŒ æµ‹è¯•å¤±è´¥ï¼å­˜åœ¨é—®é¢˜éœ€è¦ä¿®å¤';
                
                const statusType = allPassed ? 'success' : 'error';
                log(finalStatus, statusType);
                updateStatus(finalStatus, statusType);
                
            } catch (error) {
                log('éªŒè¯ç»“æœå¤±è´¥: ' + error.message, 'error');
                updateStatus('éªŒè¯å¤±è´¥', 'error');
                console.error(error);
            }
        }
        
        // æ¸…ç©ºç”»å¸ƒ
        function clearAll() {
            if (workflowApp) {
                workflowApp.graph.clear();
                testContainer = null;
                testNodes = [];
                testLinks = [];
                log('ç”»å¸ƒå·²æ¸…ç©º', 'info');
                updateStatus('ç”»å¸ƒå·²æ¸…ç©º - å¯ä»¥é‡æ–°å¼€å§‹æµ‹è¯•', 'info');
            }
        }
        
        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            log('å¼€å§‹è¿è¡Œå®Œæ•´è‡ªåŠ¨åŒ–æµ‹è¯•...', 'info');
            updateStatus('è¿è¡Œå®Œæ•´æµ‹è¯•ä¸­...', 'warning');
            
            try {
                // æ­¥éª¤1ï¼šåˆ›å»ºæµ‹è¯•åœºæ™¯
                createTestScenario();
                await sleep(500);
                
                // æ­¥éª¤2ï¼šåˆ›å»ºè¿æ¥çº¿
                createConnections();
                await sleep(500);
                
                // æ­¥éª¤3ï¼šæµ‹è¯•åˆ é™¤
                testContainerDeletion();
                
            } catch (error) {
                log('å®Œæ•´æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                updateStatus('å®Œæ•´æµ‹è¯•å¤±è´¥', 'error');
            }
        }
        
        // å·¥å…·å‡½æ•°
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('test-status');
            statusEl.textContent = message;
            statusEl.className = `test-status status-${type}`;
        }
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
