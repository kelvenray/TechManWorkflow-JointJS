<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’¤é”€/é‡åšå’Œå¤åˆ¶/ç²˜è´´åŠŸèƒ½æµ‹è¯•</title>
    
    <!-- JointJS CSS -->
    <link rel="stylesheet" href="js/lib/jointjs-3.7.7.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .test-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .test-button:hover {
            background: #1976D2;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .test-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        #canvas {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
        }
        
        .instructions {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #f57c00;
        }
        
        .instructions ul {
            margin-bottom: 0;
        }
        
        .keyboard-shortcuts {
            background: #f3e5f5;
            border: 1px solid #ce93d8;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .keyboard-shortcuts h3 {
            margin-top: 0;
            color: #7b1fa2;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .shortcut-key {
            font-family: monospace;
            background: #e1bee7;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="instructions">
        <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
        <ul>
            <li>ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®åˆ›å»ºä¸åŒç±»å‹çš„èŠ‚ç‚¹</li>
            <li>æµ‹è¯•æ’¤é”€/é‡åšåŠŸèƒ½ï¼ˆæŒ‰é’®æˆ–é”®ç›˜å¿«æ·é”®ï¼‰</li>
            <li>é€‰ä¸­èŠ‚ç‚¹åæµ‹è¯•å¤åˆ¶/ç²˜è´´åŠŸèƒ½</li>
            <li>è§‚å¯ŸçŠ¶æ€ä¿¡æ¯çš„å˜åŒ–</li>
        </ul>
    </div>

    <div class="keyboard-shortcuts">
        <h3>âŒ¨ï¸ é”®ç›˜å¿«æ·é”®</h3>
        <div class="shortcut-item">
            <span>æ’¤é”€</span>
            <span class="shortcut-key">Ctrl+Z</span>
        </div>
        <div class="shortcut-item">
            <span>é‡åš</span>
            <span class="shortcut-key">Ctrl+Y æˆ– Ctrl+Shift+Z</span>
        </div>
        <div class="shortcut-item">
            <span>å¤åˆ¶</span>
            <span class="shortcut-key">Ctrl+C</span>
        </div>
        <div class="shortcut-item">
            <span>ç²˜è´´</span>
            <span class="shortcut-key">Ctrl+V</span>
        </div>
        <div class="shortcut-item">
            <span>åˆ é™¤é€‰ä¸­</span>
            <span class="shortcut-key">Delete æˆ– Backspace</span>
        </div>
    </div>

    <div class="test-container">
        <div class="test-title">ğŸ¯ èŠ‚ç‚¹åˆ›å»ºæµ‹è¯•</div>
        <div class="test-controls">
            <button class="test-button" onclick="createTestNode('start')">åˆ›å»ºå¼€å§‹èŠ‚ç‚¹</button>
            <button class="test-button" onclick="createTestNode('process')">åˆ›å»ºæµç¨‹èŠ‚ç‚¹</button>
            <button class="test-button" onclick="createTestNode('decision')">åˆ›å»ºå†³ç­–èŠ‚ç‚¹</button>
            <button class="test-button" onclick="createTestNode('switch')">åˆ›å»ºSwitchèŠ‚ç‚¹</button>
            <button class="test-button" onclick="createTestNode('container')">åˆ›å»ºå®¹å™¨èŠ‚ç‚¹</button>
            <button class="test-button" onclick="createTestNode('end')">åˆ›å»ºç»“æŸèŠ‚ç‚¹</button>
        </div>
    </div>

    <div class="test-container">
        <div class="test-title">â†©ï¸ æ’¤é”€/é‡åšæµ‹è¯•</div>
        <div class="test-controls">
            <button class="test-button" id="undoBtn" onclick="testUndo()">æ’¤é”€ (Ctrl+Z)</button>
            <button class="test-button" id="redoBtn" onclick="testRedo()">é‡åš (Ctrl+Y)</button>
            <button class="test-button" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
        </div>
        <div id="historyStatus" class="test-status status-info">
            å†å²çŠ¶æ€ï¼šæ’¤é”€æ ˆ 0 | é‡åšæ ˆ 0
        </div>
    </div>

    <div class="test-container">
        <div class="test-title">ğŸ“‹ å¤åˆ¶/ç²˜è´´æµ‹è¯•</div>
        <div class="test-controls">
            <button class="test-button" id="copyBtn" onclick="testCopy()">å¤åˆ¶é€‰ä¸­ (Ctrl+C)</button>
            <button class="test-button" id="pasteBtn" onclick="testPaste()">ç²˜è´´ (Ctrl+V)</button>
            <button class="test-button" onclick="clearClipboard()">æ¸…ç©ºå‰ªè´´æ¿</button>
        </div>
        <div id="clipboardStatus" class="test-status status-info">
            å‰ªè´´æ¿çŠ¶æ€ï¼šç©º
        </div>
    </div>

    <div class="test-container">
        <div class="test-title">ğŸ–¼ï¸ å·¥ä½œæµç”»å¸ƒ</div>
        <div id="canvas"></div>
    </div>

    <!-- JointJS ä¾èµ– -->
    <script src="js/lib/jquery-3.7.1.min.js"></script>
    <script src="js/lib/underscore-1.13.6.min.js"></script>
    <script src="js/lib/backbone-1.4.1.min.js"></script>
    <script src="js/lib/jointjs-3.7.7.min.js"></script>

    <!-- åº”ç”¨æ¨¡å— -->
    <script src="js/core/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    
    <!-- å‘½ä»¤ç³»ç»Ÿ -->
    <script src="js/features/command-history.js"></script>
    <script src="js/features/commands/node-commands.js"></script>
    <script src="js/features/commands/property-commands.js"></script>
    <script src="js/features/clipboard-manager.js"></script>
    
    <!-- æ ¸å¿ƒåŠŸèƒ½ -->
    <script src="js/core/graph.js"></script>
    <script src="js/features/node-manager.js"></script>

    <script>
        let workflowApp;
        let nodeCounter = 0;

        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            try {
                workflowApp = new WorkflowApp();
                await workflowApp.init();
                
                // è®¾ç½®ç”»å¸ƒå®¹å™¨
                document.getElementById('canvas').appendChild(workflowApp.paper.el);
                
                updateStatus();
                console.log('æµ‹è¯•åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                workflowApp.paper.on('element:pointerclick', function(elementView) {
                    workflowApp.state.selectedElement = elementView.model;
                    updateStatus();
                });
                
                workflowApp.paper.on('blank:pointerclick', function() {
                    workflowApp.state.selectedElement = null;
                    updateStatus();
                });
                
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                showStatus('error', 'åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åˆ›å»ºæµ‹è¯•èŠ‚ç‚¹
        function createTestNode(type) {
            if (!workflowApp) {
                showStatus('error', 'åº”ç”¨æœªåˆå§‹åŒ–');
                return;
            }

            try {
                const x = 100 + (nodeCounter % 5) * 150;
                const y = 100 + Math.floor(nodeCounter / 5) * 100;
                
                const nodeManager = new NodeManager(workflowApp);
                const node = nodeManager.createNode(type, x, y);
                
                if (node) {
                    nodeCounter++;
                    showStatus('success', `${type}èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ`);
                    updateStatus();
                } else {
                    showStatus('error', `${type}èŠ‚ç‚¹åˆ›å»ºå¤±è´¥`);
                }
            } catch (error) {
                console.error('åˆ›å»ºèŠ‚ç‚¹å¤±è´¥:', error);
                showStatus('error', 'åˆ›å»ºèŠ‚ç‚¹å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•æ’¤é”€
        function testUndo() {
            if (!workflowApp || !workflowApp.commandHistory) {
                showStatus('error', 'å‘½ä»¤å†å²æœªåˆå§‹åŒ–');
                return;
            }

            const success = workflowApp.commandHistory.undo();
            if (success) {
                showStatus('success', 'æ’¤é”€æ“ä½œæˆåŠŸ');
            } else {
                showStatus('info', 'æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ');
            }
            updateStatus();
        }

        // æµ‹è¯•é‡åš
        function testRedo() {
            if (!workflowApp || !workflowApp.commandHistory) {
                showStatus('error', 'å‘½ä»¤å†å²æœªåˆå§‹åŒ–');
                return;
            }

            const success = workflowApp.commandHistory.redo();
            if (success) {
                showStatus('success', 'é‡åšæ“ä½œæˆåŠŸ');
            } else {
                showStatus('info', 'æ²¡æœ‰å¯é‡åšçš„æ“ä½œ');
            }
            updateStatus();
        }

        // æµ‹è¯•å¤åˆ¶
        function testCopy() {
            if (!workflowApp || !workflowApp.clipboardManager) {
                showStatus('error', 'å‰ªè´´æ¿ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                return;
            }

            const success = workflowApp.clipboardManager.copy();
            if (success) {
                showStatus('success', 'èŠ‚ç‚¹å¤åˆ¶æˆåŠŸ');
            } else {
                showStatus('info', 'æ²¡æœ‰å¯å¤åˆ¶çš„èŠ‚ç‚¹æˆ–èŠ‚ç‚¹ä¸å¯å¤åˆ¶');
            }
            updateStatus();
        }

        // æµ‹è¯•ç²˜è´´
        function testPaste() {
            if (!workflowApp || !workflowApp.clipboardManager) {
                showStatus('error', 'å‰ªè´´æ¿ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                return;
            }

            const result = workflowApp.clipboardManager.paste();
            if (result && result.length > 0) {
                showStatus('success', `ç²˜è´´äº† ${result.length} ä¸ªèŠ‚ç‚¹`);
            } else {
                showStatus('info', 'å‰ªè´´æ¿ä¸ºç©ºæˆ–ç²˜è´´å¤±è´¥');
            }
            updateStatus();
        }

        // æ¸…ç©ºå†å²
        function clearHistory() {
            if (workflowApp && workflowApp.commandHistory) {
                workflowApp.commandHistory.clear();
                showStatus('success', 'å†å²è®°å½•å·²æ¸…ç©º');
                updateStatus();
            }
        }

        // æ¸…ç©ºå‰ªè´´æ¿
        function clearClipboard() {
            if (workflowApp && workflowApp.clipboardManager) {
                workflowApp.clipboardManager.clear();
                showStatus('success', 'å‰ªè´´æ¿å·²æ¸…ç©º');
                updateStatus();
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            if (!workflowApp) return;

            // æ›´æ–°å†å²çŠ¶æ€
            if (workflowApp.commandHistory) {
                const historyStatus = workflowApp.commandHistory.getStatus();
                document.getElementById('historyStatus').textContent = 
                    `å†å²çŠ¶æ€ï¼šæ’¤é”€æ ˆ ${historyStatus.undoCount} | é‡åšæ ˆ ${historyStatus.redoCount}`;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('undoBtn').disabled = !historyStatus.canUndo;
                document.getElementById('redoBtn').disabled = !historyStatus.canRedo;
            }

            // æ›´æ–°å‰ªè´´æ¿çŠ¶æ€
            if (workflowApp.clipboardManager) {
                const clipboardStatus = workflowApp.clipboardManager.getStatus();
                const selectedNode = workflowApp.state.selectedElement;
                
                document.getElementById('clipboardStatus').textContent = 
                    `å‰ªè´´æ¿çŠ¶æ€ï¼š${clipboardStatus.isEmpty ? 'ç©º' : `${clipboardStatus.nodeCount} ä¸ªèŠ‚ç‚¹`} | é€‰ä¸­ï¼š${selectedNode ? 'æœ‰èŠ‚ç‚¹' : 'æ— '}`;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('copyBtn').disabled = !selectedNode;
                document.getElementById('pasteBtn').disabled = clipboardStatus.isEmpty;
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(type, message) {
            // åˆ›å»ºçŠ¶æ€æ¶ˆæ¯å…ƒç´ 
            const statusDiv = document.createElement('div');
            statusDiv.className = `test-status status-${type}`;
            statusDiv.textContent = message;
            
            // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
            document.body.insertBefore(statusDiv, document.body.firstChild);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
